工程描述
1. 系统架构概述
这是一个基于GD32F4系列微控制器的嵌入式电压采集系统，采用了模块化的设计架构。系统通过ADC模块采集电压信号，经过处理后在OLED显示屏上实时显示，并将数据存储到SD卡中。系统还支持通过UART串口进行配置和控制。
2. 核心功能模块
2.1 主控模块 (main.c)
系统初始化：外设初始化、Flash初始化、ADC DMA初始化、UART DMA初始化
任务调度器初始化和运行
数据存储模块初始化
主循环中运行任务调度器
2.2 任务调度器 (scheduler.c)
实现了基于时间片的任务调度机制，管理以下任务：
LED任务(100ms周期)：控制LED状态指示
按键任务(10ms周期)：处理按键输入
UART任务(5ms周期)：处理串口通信
OLED显示任务(200ms周期)：更新OLED显示内容
ADC采集任务(5ms周期)：处理ADC数据采集
2.3 ADC采集模块 (adc_app.c)
使用DMA方式进行ADC数据采集，提高效率
采用32点采样缓冲区，通过求平均值来减少噪声影响
支持电压校准功能，通过ratio系数对测量值进行修正
从SD卡配置文件读取校准参数
2.4 数据存储模块 (data_storage_app.c)
基于FatFs文件系统的数据存储方案
支持多种数据类型存储：
周期采样数据(sample目录)
超限数据(overLimit目录)
系统日志(log目录)
隐藏模式数据(hideData目录)
自动文件管理：每10条记录创建一个新文件
支持启动计数功能，记录系统启动次数
2.5 OLED显示模块 (oled_app.c)
实时显示系统时间和电压值
支持周期采样模式和空闲状态显示
LED状态指示：LED1表示采样状态，LED2表示超限状态
支持隐藏模式显示，仅输出十六进制格式数据
2.6 UART通信模块 (usart_app.c)
使用DMA空闲中断方式接收数据，提高效率
支持丰富的命令集：
系统测试命令(test)
配置查看命令(conf)
校准参数设置命令(ratio, limit)
配置保存/读取命令(config save/read)
采样控制命令(start/stop)
隐藏模式命令(hide/unhide)
2.7 SD卡配置模块 (sd_app.c)
支持INI格式配置文件(config.ini)
包含Ratio(校准系数)和Limit(报警阈值)两个配置项
支持配置文件的读取、修改和创建
具备SD卡状态检测和文件系统诊断功能
支持SD卡堆栈重新初始化，提高系统稳定性
3. 系统工作流程
系统启动：初始化所有外设，读取SD卡配置参数，初始化数据存储模块
任务调度：按照设定的时间周期执行各个任务
数据采集：ADC模块持续采集电压数据，通过DMA传输到缓冲区
数据处理：计算平均值，应用校准系数得到实际电压值
数据显示：在OLED屏幕上实时显示时间、电压等信息
数据存储：根据配置将采样数据、超限数据等分类存储到SD卡
串口通信：响应用户命令，提供配置修改、状态查询等功能
异常处理：具备SD卡错误恢复机制，确保系统稳定运行
4. 特色功能
隐藏模式：支持以十六进制格式输出数据，适用于特殊应用场景
超限报警：当电压超过设定阈值时，通过LED和数据记录进行报警
配置持久化：支持将SD卡配置保存到SPI Flash中，实现掉电保存
自适应文件管理：自动创建目录和文件，避免单个文件过大
错误恢复机制：具备SD卡堆栈重新初始化功能，提高系统鲁棒性
这个系统非常适合用于需要长期监测电压变化并在特定条件下进行数据记录和报警的应用场景。
